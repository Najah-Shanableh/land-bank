<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBroCTXbMjlkQTtTjuICn2sMKtM7IssVp0&sensor=false"></script>
<script type="text/javascript" src="/static/landbank_data/wax/dist/wax.g.js"></script>
<link href="/static/landbank_data/wax/theme/controls.css" rel="stylesheet" type="text/css" />
<script src="/static/landbank_data/js/dajaxice.core.js"></script>
<script src="/static/landbank_data/js/jquery.dajax.core.js"></script>
<script type="text/javascript">
function onGotPropertyData(property) {
  console.log('onGotPropertyData');
  console.log(property);
}
function initialize() {
  var mapOptions = {
    zoom: 14,
    center: new google.maps.LatLng({{mapcenter.lat}}, {{mapcenter.lon}}),
    mapTypeControl: false,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  var bounds = new google.maps.LatLngBounds();
  var map = new google.maps.Map(document.getElementById("map-aggregate"),
      mapOptions);
  // todo: get ALL polygons for areas and add them to map...
  var polygonCoords = [
    {% with outline.0.0 as the_polygon %}
        {% for point in the_polygon %}
          new google.maps.LatLng({{ point.1 }}, {{ point.0 }}),
        {% endfor %}
      {% endwith %}
    ];
    var the_polygon = new google.maps.Polygon({
      clickable: false,
      paths: polygonCoords,
      strokeColor: "#222",
      strokeOpacity: 0.8,
      strokeWeight: 5,
      fillColor: null,
      fillOpacity: 0
    });

    for (i=0; i<polygonCoords.length; i++) {
      bounds.extend(polygonCoords[i]);
    }

    the_polygon.setMap(map);

  var transitLayer = new google.maps.TransitLayer();
  transitLayer.setMap(map); 

  // Composited raster layer of parcel outline and shaded foreclosure
  var base_foreclosure_url = 'http://api.tiles.mapbox.com/v3/salice412.parcel,salice412.parcel_foreclosure.jsonp';
  wax.tilejson(base_foreclosure_url,
    function(tilejson) {
      map.overlayMapTypes.insertAt(0, new wax.g.connector(tilejson));
    });
  map.fitBounds(bounds);
  google.maps.event.addDomListener(map, 'click', function(e) {
    Dajaxice.landbank_data.get_property_from_latlng(Dajax.process,
      {'lat':e.latLng.lat()
      ,'lng':e.latLng.lng()
    });
  });
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>
